name: Auto Fix Code Style

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: 3.13

    - name: Install dependencies
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        uv sync
        uv install
        pip install black isort flake8 mypy

    - name: Run black autoformat
      run: uv run black .

    - name: Run isort autoimport sort
      run: uv run isort .

    - name: Check if there are changes after auto-fix
      id: git-check
      run: |
        echo "::set-output name=changed::$(git status --porcelain)"
    
    - name: Commit and push fixes
      if: steps.git-check.outputs.changed != ''
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "Auto fix code style by GitHub Actions"
        git push origin HEAD:${{ github.head_ref }}