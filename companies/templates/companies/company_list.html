{% extends "base.html" %}

{% block title %}Компании - CRM Система{% endblock %}

{% block nav_menu %}
<li><a href="{% url 'users:dashboard' %}"><i class="fas fa-tachometer-alt"></i> Дашборд</a></li>
<li><a href="{% url 'companies:list' %}" class="active"><i class="fas fa-building"></i> Компании</a></li>
<li><a href="{% url 'contacts:list' %}"><i class="fas fa-users"></i> Контакты</a></li>
<li><a href="{% url 'projects:list' %}"><i class="fas fa-project-diagram"></i> Проекты</a></li>
<li><a href="{% url 'emails:list' %}"><i class="fas fa-envelope"></i> Email</a></li>
{% endblock %}

{% block breadcrumbs %}
<nav class="text-sm breadcrumbs">
  <ul>
    <li><a href="{% url 'users:dashboard' %}">Главная</a></li>
    <li>Компании</li>
  </ul>
</nav>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  <!-- Статистика -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body p-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-sm font-medium text-base-content/70">Всего компаний</h3>
            <p class="text-2xl font-bold text-primary">{{ stats.total_companies }}</p>
          </div>
          <i class="fas fa-building text-3xl text-primary/50"></i>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow-lg">
      <div class="card-body p-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-sm font-medium text-base-content/70">Клиентов</h3>
            <p class="text-2xl font-bold text-success">{{ stats.clients }}</p>
          </div>
          <i class="fas fa-users text-3xl text-success/50"></i>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow-lg">
      <div class="card-body p-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-sm font-medium text-base-content/70">Поставщиков</h3>
            <p class="text-2xl font-bold text-warning">{{ stats.suppliers }}</p>
          </div>
          <i class="fas fa-truck text-3xl text-warning/50"></i>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow-lg">
      <div class="card-body p-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-sm font-medium text-base-content/70">Общий долг</h3>
            <p class="text-2xl font-bold text-error">{{ stats.total_debt|floatformat:0 }} ₽</p>
          </div>
          <i class="fas fa-ruble-sign text-3xl text-error/50"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Фильтры и поиск -->
  <div class="card bg-base-100 shadow-lg mb-6">
    <div class="card-body">
      <form method="get" class="flex flex-col lg:flex-row gap-4">
        <div class="flex-1">
          <input type="text" name="q" placeholder="Поиск по названию, ИНН, email..."
                 value="{{ request.GET.q }}" class="input input-bordered w-full">
        </div>

        <div class="flex gap-2">
          <select name="company_type" class="select select-bordered">
            <option value="">Все типы</option>
            <option value="client" {% if request.GET.company_type == 'client' %}selected{% endif %}>Клиенты</option>
            <option value="supplier" {% if request.GET.company_type == 'supplier' %}selected{% endif %}>Поставщики</option>
            <option value="partner" {% if request.GET.company_type == 'partner' %}selected{% endif %}>Партнеры</option>
          </select>

          <select name="status" class="select select-bordered">
            <option value="">Все статусы</option>
            <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Активные</option>
            <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Неактивные</option>
            <option value="blocked" {% if request.GET.status == 'blocked' %}selected{% endif %}>Заблокированные</option>
          </select>

          <label class="label cursor-pointer">
            <input type="checkbox" name="has_debt" {% if request.GET.has_debt %}checked{% endif %} class="checkbox">
            <span class="label-text ml-2">С долгом</span>
          </label>
        </div>

        <div class="flex gap-2">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-search"></i>
            Поиск
          </button>
          <a href="{% url 'companies:list' %}" class="btn btn-outline">
            <i class="fas fa-times"></i>
            Сброс
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Кнопка создания -->
  <div class="mb-6">
    <a href="{% url 'companies:company_create' %}" class="btn btn-primary">
      <i class="fas fa-plus"></i>
      Добавить компанию
    </a>
  </div>

  <!-- Список компаний -->
  <div class="card bg-base-100 shadow-lg">
    <div class="card-body">
      {% if companies %}
        <div class="overflow-x-auto">
          <table class="table table-zebra w-full">
            <thead>
              <tr>
                <th>Название</th>
                <th>ИНН</th>
                <th>Тип</th>
                <th>Статус</th>
                <th>Долг</th>
                <th>Контакты</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for company in companies %}
                <tr>
                  <td>
                    <div class="flex items-center space-x-3">
                      <div class="avatar placeholder">
                        <div class="bg-neutral-focus text-neutral-content rounded-full w-8">
                          <span class="text-xs">{{ company.name|first|upper }}</span>
                        </div>
                      </div>
                      <div>
                        <div class="font-bold">
                          <a href="{% url 'companies:company_detail' company.pk %}" class="link link-primary">
                            {{ company.name }}
                          </a>
                        </div>
                        {% if company.contact_person %}
                          <div class="text-sm opacity-50">{{ company.contact_person }}</div>
                        {% endif %}
                      </div>
                    </div>
                  </td>
                  <td>{{ company.inn|default:"—" }}</td>
                  <td>
                    <div class="badge {% if company.company_type == 'client' %}badge-success{% elif company.company_type == 'supplier' %}badge-warning{% else %}badge-info{% endif %}">
                      {{ company.get_company_type_display }}
                    </div>
                  </td>
                  <td>
                    <div class="badge {% if company.status == 'active' %}badge-success{% elif company.status == 'inactive' %}badge-warning{% else %}badge-error{% endif %}">
                      {{ company.get_status_display }}
                    </div>
                  </td>
                  <td>
                    {% if company.current_debt > 0 %}
                      <span class="text-error font-semibold">{{ company.current_debt|floatformat:0 }} ₽</span>
                    {% else %}
                      <span class="text-success">—</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="flex flex-col">
                      {% if company.email %}
                        <a href="mailto:{{ company.email }}" class="link link-primary text-sm">
                          <i class="fas fa-envelope"></i> {{ company.email }}
                        </a>
                      {% endif %}
                      {% if company.phone %}
                        <a href="tel:{{ company.phone }}" class="link link-primary text-sm">
                          <i class="fas fa-phone"></i> {{ company.phone }}
                        </a>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="dropdown dropdown-left">
                      <label tabindex="0" class="btn btn-ghost btn-sm">
                        <i class="fas fa-ellipsis-v"></i>
                      </label>
                      <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                        <li><a href="{% url 'companies:company_detail' company.pk %}">
                          <i class="fas fa-eye"></i> Просмотр
                        </a></li>
                        <li><a href="{% url 'companies:company_update' company.pk %}">
                          <i class="fas fa-edit"></i> Редактировать
                        </a></li>
                        <li><a href="{% url 'companies:order_create' %}?company={{ company.pk }}" class="text-success">
                          <i class="fas fa-plus"></i> Создать заказ
                        </a></li>
                        <li><a href="{% url 'companies:payment_create' %}?company={{ company.pk }}" class="text-info">
                          <i class="fas fa-credit-card"></i> Добавить платеж
                        </a></li>
                        <li>
                          <a href="{% url 'companies:company_delete' company.pk %}" class="text-error"
                             onclick="return confirm('Вы уверены, что хотите удалить эту компанию?')">
                            <i class="fas fa-trash"></i> Удалить
                          </a>
                        </li>
                      </ul>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Пагинация -->
        {% if is_paginated %}
          <div class="flex justify-center mt-6">
            <div class="join">
              {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                   class="join-item btn">«</a>
              {% endif %}

              <span class="join-item btn btn-active">
                Страница {{ page_obj.number }} из {{ paginator.num_pages }}
              </span>

              {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                   class="join-item btn">»</a>
              {% endif %}
            </div>
          </div>
        {% endif %}

      {% else %}
        <div class="text-center py-12">
          <i class="fas fa-building text-6xl text-base-content/20 mb-4"></i>
          <h3 class="text-lg font-semibold mb-2">Компании не найдены</h3>
          <p class="text-base-content/70 mb-4">
            {% if request.GET %}
              Попробуйте изменить параметры поиска или
            {% endif %}
            добавьте первую компанию в систему.
          </p>
          <a href="{% url 'companies:company_create' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            Добавить компанию
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// AJAX поиск (опционально, для будущего улучшения)
document.addEventListener('DOMContentLoaded', function() {
    // Можно добавить AJAX функциональность для поиска без перезагрузки страницы
});
</script>
{% endblock %}