{% extends 'base.html' %}
{% load static %}

{% block title %}Настройки Email - CRM Pro{% endblock %}
{% block nav_menu %} {% include "partials/navmenu.html" %} {% endblock %}
{% block mobile_menu %} {% include "partials/mobilemenu.html" %} {% endblock %}
{% block breadcrumbs %}
    <nav class="text-sm breadcrumbs">
        <ul>
            <li><a href="{% url 'emails:email_list' %}">Email</a></li>
            <li><a href="{% url 'emails:credentials' %}">Настройки</a></li>
        </ul>
    </nav>
{% endblock %}

{% block content %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Settings -->
        <div class="lg:col-span-2">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <i class="fas fa-cog"></i>
                        Настройки подключения к Exchange
                    </h2>

                    <form method="post" class="space-y-4">
                        {% csrf_token %}

                        <!-- Email Credentials -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Email адрес</span>
                            </label>
                            <input type="email" name="email" value="{{ credentials.email }}"
                                   class="input input-bordered" placeholder="user@company.com" required>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Сервер Exchange</span>
                            </label>
                            <input type="text" name="server" value="{{ credentials.server }}"
                                   class="input input-bordered" placeholder="mail.company.com" required>
                            <label class="label">
                                <span class="label-text-alt">Адрес сервера Exchange (без https://)</span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Пароль</span>
                            </label>
                            <input type="password" name="password" class="input input-bordered"
                                   placeholder="Пароль от email" required>
                            <label class="label">
                                <span class="label-text-alt">Пароль будет сохранен в зашифрованном виде</span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label cursor-pointer">
                                <span class="label-text">Использовать SSL/TLS</span>
                                <input type="checkbox" name="use_ssl" {% if credentials.use_ssl %}checked{% endif %}
                                       class="checkbox checkbox-primary">
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label cursor-pointer">
                                <span class="label-text">Активно</span>
                                <input type="checkbox" name="is_active" {% if credentials.is_active %}checked{% endif %}
                                       class="checkbox checkbox-primary">
                            </label>
                        </div>

                        <div class="form-control">
                            <button type="submit" name="save_credentials" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Сохранить настройки
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Processing Rules -->
            <div class="card bg-base-100 shadow-xl mt-6">
                <div class="card-body">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="card-title">
                            <i class="fas fa-filter"></i>
                            Правила обработки
                        </h2>
                        <a href="{% url 'emails:rule_create' %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i>
                            Добавить правило
                        </a>
                    </div>

                    <div class="space-y-2">
                        {% for rule in credentials.processing_rules.all %}
                            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                                <div>
                                    <h4 class="font-semibold">{{ rule.name }}</h4>
                                    <p class="text-sm text-base-content/70">{{ rule.description }}</p>
                                    <div class="flex space-x-2 mt-1">
                                        <span class="badge badge-outline badge-sm">{{ rule.get_condition_display }}</span>
                                        <span class="badge badge-outline badge-sm">{{ rule.get_action_display }}</span>
                                        {% if rule.is_active %}
                                            <span class="badge badge-success badge-sm">Активно</span>
                                        {% else %}
                                            <span class="badge badge-neutral badge-sm">Неактивно</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <a href="{% url 'emails:rule_update' rule.id %}" class="btn btn-ghost btn-xs">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button onclick="deleteRule({{ rule.id }})" class="btn btn-ghost btn-xs text-error">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-center text-base-content/50 py-4">Нет правил обработки</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Test Connection -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <i class="fas fa-plug"></i>
                        Тест подключения
                    </h2>

                    <form method="post" class="space-y-4">
                        {% csrf_token %}

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Email</span>
                            </label>
                            <input type="email" name="test_email" class="input input-bordered input-sm"
                                   placeholder="user@company.com" required>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Пароль</span>
                            </label>
                            <input type="password" name="test_password" class="input input-bordered input-sm"
                                   placeholder="Пароль" required>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Сервер</span>
                            </label>
                            <input type="text" name="test_server" class="input input-bordered input-sm"
                                   placeholder="mail.company.com" required>
                        </div>

                        <div class="form-control">
                            <button type="submit" name="test_connection" class="btn btn-secondary btn-sm">
                                <i class="fas fa-plug"></i>
                                Протестировать
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sync Status -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <i class="fas fa-sync"></i>
                        Статус синхронизации
                    </h2>

                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Последняя синхронизация</span>
                            <span class="text-sm font-mono">
                            {% if credentials.last_sync %}
                                {{ credentials.last_sync|date:"d.m.Y H:i" }}
                            {% else %}
                                Никогда
                            {% endif %}
                        </span>
                        </div>

                        <div class="flex justify-between items-center">
                            <span class="text-sm">Статус</span>
                            <span class="badge {% if credentials.sync_status == 'success' %}badge-success{% elif credentials.sync_status == 'error' %}badge-error{% else %}badge-warning{% endif %}">
                            {{ credentials.get_sync_status_display }}
                        </span>
                        </div>

                        <div class="flex justify-between items-center">
                            <span class="text-sm">Всего сообщений</span>
                            <span class="text-sm font-mono">{{ credentials.total_messages|default:0 }}</span>
                        </div>

                        <div class="flex justify-between items-center">
                            <span class="text-sm">Обработано</span>
                            <span class="text-sm font-mono">{{ credentials.processed_messages|default:0 }}</span>
                        </div>
                    </div>

                    <div class="form-control mt-4">
                        <button onclick="syncNow()" class="btn btn-primary btn-sm">
                            <i class="fas fa-sync"></i>
                            Синхронизировать сейчас
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Sync Logs -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <i class="fas fa-history"></i>
                        Последние синхронизации
                    </h2>

                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        {% for log in sync_logs %}
                            <div class="flex items-center space-x-2 text-sm">
                                <div class="w-2 h-2 rounded-full {% if log.status == 'success' %}bg-success{% elif log.status == 'error' %}bg-error{% else %}bg-warning{% endif %}"></div>
                                <div class="flex-1">
                                    <div class="font-medium">{{ log.get_status_display }}</div>
                                    <div class="text-xs text-base-content/70">
                                        {{ log.started_at|date:"d.m.Y H:i" }}
                                        {% if log.duration %}
                                            ({{ log.duration }} сек)
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-center text-base-content/50 py-4 text-sm">Нет логов синхронизации</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Help -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <i class="fas fa-question-circle"></i>
                        Помощь
                    </h2>

                    <div class="space-y-2 text-sm">
                        <div>
                            <h4 class="font-semibold">Сервер Exchange</h4>
                            <p class="text-base-content/70">Укажите адрес сервера Exchange вашей организации</p>
                        </div>

                        <div>
                            <h4 class="font-semibold">Права доступа</h4>
                            <p class="text-base-content/70">Убедитесь, что у аккаунта есть права на чтение почты</p>
                        </div>

                        <div>
                            <h4 class="font-semibold">Безопасность</h4>
                            <p class="text-base-content/70">Пароли хранятся в зашифрованном виде</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
        function syncNow() {
            fetch('/emails/ajax/sync-now/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Синхронизация запущена', 'Это может занять несколько минут', 'info');
                        // Refresh the page after 5 seconds to show updated status
                        setTimeout(() => location.reload(), 5000);
                    } else {
                        showNotification('Ошибка', data.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('Ошибка', 'Не удалось запустить синхронизацию', 'error');
                });
        }

        function deleteRule(ruleId) {
            if (confirm('Вы уверены, что хотите удалить это правило?')) {
                fetch(`/emails/rules/${ruleId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                })
                    .then(response => {
                        if (response.ok) {
                            showNotification('Правило удалено', '', 'success');
                            location.reload();
                        } else {
                            showNotification('Ошибка', 'Не удалось удалить правило', 'error');
                        }
                    });
            }
        }

        // Auto-refresh sync status every 30 seconds
        setInterval(() => {
            // Only refresh if we're on the credentials page
            if (window.location.pathname.includes('credentials')) {
                location.reload();
            }
        }, 30000);
    </script>
{% endblock %}